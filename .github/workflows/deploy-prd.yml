name: Deploy Prd

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      publish_all_modules:
        description: "Publish all modules regardless of changes"
        type: boolean
        default: true
  schedule:
    - cron: "0 3 * * 4"

permissions: {}

concurrency:
  group: ${{ github.workflow }}

jobs:
  terraform-plan-and-apply-dev:
    permissions:
      contents: read
      id-token: write
    environment: Development
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.repository }}-dev
    steps:
      - uses: frasermolyneux/actions/terraform-plan-and-apply@main
        with:
          terraform-folder: "terraform"
          terraform-var-file: "tfvars/dev.tfvars"
          terraform-backend-file: "backends/dev.backend.hcl"
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

  terraform-plan-and-apply-prd:
    permissions:
      contents: read
      id-token: write
    environment: Production
    needs: terraform-plan-and-apply-dev
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.repository }}-prd
    steps:
      - uses: frasermolyneux/actions/terraform-plan-and-apply@main
        with:
          terraform-folder: "terraform"
          terraform-var-file: "tfvars/prd.tfvars"
          terraform-backend-file: "backends/prd.backend.hcl"
          AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

  publish-modules:
    permissions:
      contents: write
      id-token: write
    environment: Production
    needs: terraform-plan-and-apply-prd
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.repository }}-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Bicep CLI
        run: az bicep install

      - name: Install Nerdbank.GitVersioning
        run: |
          dotnet tool install --global nbgv
          echo "PATH=$PATH:$HOME/.dotnet/tools" >> $GITHUB_ENV

      - name: Az CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}

      - name: Resolve ACR name
        id: acr
        run: |
          ACR_NAME=$(az acr list --resource-group "rg-platform-registry-prd-uksouth" --query "[0].name" -o tsv)
          echo "acr_name=$ACR_NAME" >> "$GITHUB_OUTPUT"
          echo "Resolved ACR: $ACR_NAME"

      - name: Detect changed modules and publish
        shell: bash
        env:
          ACR_NAME: ${{ steps.acr.outputs.acr_name }}
          PUBLISH_ALL: ${{ github.event_name == 'workflow_dispatch' && inputs.publish_all_modules == true || github.event_name == 'schedule' }}
        run: |
          set -euo pipefail
          export PATH="$PATH:$HOME/.dotnet/tools"

          MODULES=(
            apiManagementLogger
            apiManagementSubscription
            appConfigurationStore
            appInsights
            frontDoorCNAME
            frontDoorEndpoint
            keyVault
            keyVaultAccessPolicy
            keyVaultRoleAssignment
            keyVaultSecret
            sqlDatabase
            storageAccount
            webTest
          )

          if [[ "$PUBLISH_ALL" == "true" ]]; then
            echo "Publishing all modules (triggered by ${{ github.event_name }})"
          else
            BEFORE="${{ github.event.before }}"
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              BEFORE=$(git rev-list --max-parents=0 HEAD)
            fi
            CHANGED=$(git diff --name-only "$BEFORE" "${{ github.sha }}")
          fi

          for MODULE in "${MODULES[@]}"; do
            if [[ "$PUBLISH_ALL" != "true" ]]; then
              if ! echo "$CHANGED" | grep -q "^modules/${MODULE}/"; then
                continue
              fi
            fi

            echo "========================================"
            echo "Processing module: $MODULE"
            echo "========================================"

            VERSION_INFO=$(nbgv get-version -p "modules/$MODULE" -f json)
            MAJOR_MINOR=$(echo "$VERSION_INFO" | jq -r '.MajorMinorVersion')

            if [[ -z "$MAJOR_MINOR" || "$MAJOR_MINOR" == "null" ]]; then
              echo "Failed to resolve major/minor version for $MODULE"
              exit 1
            fi

            MAJOR="${MAJOR_MINOR%%.*}"
            if [[ -z "$MAJOR" ]]; then
              echo "Failed to resolve major version for $MODULE"
              exit 1
            fi

            # Determine patch version from existing git tags
            PATCH_TAG_PREFIX="${MODULE}/v${MAJOR_MINOR}."
            CURRENT_PATCH_TAG=
            while IFS= read -r TAG; do
              if [[ "$TAG" == ${PATCH_TAG_PREFIX}* ]]; then
                PATCH="${TAG#${PATCH_TAG_PREFIX}}"
                if [[ "$PATCH" =~ ^[0-9]+$ ]]; then
                  CURRENT_PATCH_TAG="$TAG"
                  break
                fi
              fi
            done < <(git tag --points-at "${GITHUB_SHA}")

            if [[ -n "$CURRENT_PATCH_TAG" ]]; then
              VERSION="${CURRENT_PATCH_TAG#${MODULE}/v}"
              PATCH_TAG="$CURRENT_PATCH_TAG"
              echo "Commit already has $PATCH_TAG. Refreshing rolling tags."
            else
              LAST_PATCH=
              while IFS= read -r TAG; do
                PATCH="${TAG#${PATCH_TAG_PREFIX}}"
                if [[ "$PATCH" =~ ^[0-9]+$ ]]; then
                  if [[ -z "$LAST_PATCH" ]]; then
                    LAST_PATCH="$PATCH"
                  elif (( PATCH > LAST_PATCH )); then
                    LAST_PATCH="$PATCH"
                  fi
                fi
              done < <(git tag -l "${PATCH_TAG_PREFIX}*")

              if [[ -n "$LAST_PATCH" ]]; then
                NEXT_PATCH=$((LAST_PATCH + 1))
              else
                NEXT_PATCH=0
              fi

              VERSION="${MAJOR_MINOR}.${NEXT_PATCH}"
              PATCH_TAG="${MODULE}/v${VERSION}"
              git tag "$PATCH_TAG"
              git push origin "$PATCH_TAG"
              echo "Published git tag $PATCH_TAG"
            fi

            # Update rolling git tags
            MAJOR_TAG="${MODULE}/v${MAJOR}"
            MINOR_TAG="${MODULE}/v${MAJOR_MINOR}"

            git tag -f "$MAJOR_TAG"
            git push --force origin "$MAJOR_TAG"
            echo "Updated rolling git tag $MAJOR_TAG"

            git tag -f "$MINOR_TAG"
            git push --force origin "$MINOR_TAG"
            echo "Updated rolling git tag $MINOR_TAG"

            # Publish to ACR
            echo "Publishing $MODULE v$VERSION to ACR $ACR_NAME"
            pwsh -Command "./scripts/Publish-BicepModuleToAcr.ps1 -moduleName '$MODULE' -modulesRootPath ./modules -acrName '$ACR_NAME' -version '$VERSION' -previewRelease \$false"

          done
